<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chord-ID Analytics</title>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* ========================================
           CSS Variables - Dark Theme
           ======================================== */
        :root {
            --primary: #6366f1;
            --primary-glow: #818cf8;
            --secondary: #8b5cf6;
            --accent: #22d3ee;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;

            --bg-dark: #0a0a0f;
            --bg-darker: #06060a;
            --bg-card: #12121a;
            --bg-card-hover: #1a1a26;
            --bg-input: #1e1e2e;
            --bg-surface: #16162a;

            --border: #2d2d3a;
            --border-light: #3d3d4a;

            --text: #ffffff;
            --text-muted: #94a3b8;
            --text-dim: #64748b;

            /* Chart Colors */
            --chart-1: #6366f1;
            --chart-2: #8b5cf6;
            --chart-3: #22d3ee;
            --chart-4: #22c55e;
            --chart-5: #f59e0b;
            --chart-6: #ef4444;
            --chart-7: #ec4899;
            --chart-8: #14b8a6;

            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -4px rgba(0, 0, 0, 0.3);
            --shadow-glow: 0 0 30px rgba(99, 102, 241, 0.15);
        }

        /* ========================================
           Reset & Base Styles
           ======================================== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 14px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(180deg, var(--bg-dark) 0%, var(--bg-darker) 100%);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
        }

        /* ========================================
           Scrollbar Styling
           ======================================== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.03);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        /* ========================================
           Login Overlay
           ======================================== */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .login-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-box h1 {
            font-size: 28px;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .login-box p {
            color: var(--text-muted);
            margin-bottom: 24px;
        }

        .login-box input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-input);
            color: var(--text);
            font-size: 16px;
            margin-bottom: 16px;
            text-align: center;
            letter-spacing: 4px;
        }

        .login-box input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .login-error {
            color: var(--danger);
            font-size: 14px;
            margin-bottom: 16px;
            display: none;
        }

        /* ========================================
           Layout
           ======================================== */
        .dashboard {
            max-width: 1600px;
            margin: 0 auto;
            padding: 24px;
            display: none;
        }

        /* ========================================
           Header Section
           ======================================== */
        .header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }

        .header-title h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-subtitle {
            color: var(--text-muted);
            font-size: 14px;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* Date Range Selector */
        .date-range-selector {
            display: flex;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 4px;
            gap: 4px;
        }

        .date-range-btn {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .date-range-btn:hover {
            color: var(--text);
            background: rgba(255, 255, 255, 0.05);
        }

        .date-range-btn.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
        }

        /* Action Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-icon { padding: 10px; }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            box-shadow: 0 2px 10px rgba(99, 102, 241, 0.25);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.35);
        }

        .btn-secondary {
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-light);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success), #16a34a);
            color: white;
        }

        .btn svg { width: 16px; height: 16px; }

        .btn.loading svg { animation: spin 1s linear infinite; }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* ========================================
           Overview Cards Grid
           ======================================== */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 28px;
        }

        @media (max-width: 1200px) { .overview-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 640px) { .overview-grid { grid-template-columns: 1fr; } }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glow);
            border-color: var(--border-light);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover::before { opacity: 1; }

        .stat-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .stat-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-card-icon.users { background: linear-gradient(135deg, var(--chart-1), var(--chart-2)); }
        .stat-card-icon.sessions { background: linear-gradient(135deg, var(--chart-3), var(--chart-4)); }
        .stat-card-icon.duration { background: linear-gradient(135deg, var(--chart-5), var(--chart-6)); }
        .stat-card-icon.events { background: linear-gradient(135deg, var(--chart-7), var(--chart-1)); }

        .stat-card-trend {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        .stat-card-trend.up { background: rgba(34, 197, 94, 0.15); color: var(--success); }
        .stat-card-trend.down { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .stat-card-trend.neutral { background: rgba(148, 163, 184, 0.15); color: var(--text-muted); }
        .stat-card-trend svg { width: 14px; height: 14px; }

        .stat-card-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 4px;
            line-height: 1.1;
        }

        .stat-card-label {
            color: var(--text-muted);
            font-size: 13px;
            font-weight: 500;
        }

        .stat-card-spark { margin-top: 16px; height: 40px; }

        /* ========================================
           Charts Grid
           ======================================== */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 28px;
        }

        @media (max-width: 1024px) { .charts-grid { grid-template-columns: 1fr; } }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }

        .chart-card:hover { box-shadow: var(--shadow-glow); }

        .chart-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .chart-card-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-card-title-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .chart-container { position: relative; height: 280px; }
        .chart-container.pie { height: 260px; }

        /* ========================================
           Engagement Section
           ======================================== */
        .engagement-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 28px;
        }

        @media (max-width: 1024px) { .engagement-grid { grid-template-columns: 1fr; } }

        /* ========================================
           Tables
           ======================================== */
        .table-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            overflow: hidden;
        }

        .table-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .table-card-title {
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .table-wrapper { overflow-x: auto; }

        .data-table { width: 100%; border-collapse: collapse; }

        .data-table th,
        .data-table td {
            padding: 14px 20px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: var(--bg-surface);
            color: var(--text-muted);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        .data-table th:hover { color: var(--text); }
        .data-table tbody tr { transition: background 0.2s ease; }
        .data-table tbody tr:hover { background: var(--bg-card-hover); }
        .data-table tbody tr:last-child td { border-bottom: none; }
        .data-table td { font-size: 13px; color: var(--text); }

        .visitor-id {
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            color: var(--primary);
            background: rgba(99, 102, 241, 0.1);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
        }

        .visitor-id:hover { background: rgba(99, 102, 241, 0.2); }

        .platform-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        .platform-badge.windows { background: rgba(59, 130, 246, 0.15); color: #60a5fa; }
        .platform-badge.macos { background: rgba(148, 163, 184, 0.15); color: #94a3b8; }
        .platform-badge.linux { background: rgba(249, 115, 22, 0.15); color: #fb923c; }
        .platform-badge.android { background: rgba(34, 197, 94, 0.15); color: #4ade80; }
        .platform-badge.ios { background: rgba(99, 102, 241, 0.15); color: #818cf8; }
        .platform-badge.unknown { background: rgba(100, 116, 139, 0.15); color: #94a3b8; }

        .table-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            background: var(--bg-surface);
        }

        .table-info { color: var(--text-muted); font-size: 13px; }
        .pagination { display: flex; gap: 4px; }

        .pagination-btn {
            padding: 8px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .pagination-btn:hover:not(:disabled) {
            background: var(--bg-card-hover);
            border-color: var(--border-light);
        }

        .pagination-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .pagination-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* ========================================
           Feature Usage
           ======================================== */
        .feature-row {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 20px;
            border-bottom: 1px solid var(--border);
        }

        .feature-row:last-child { border-bottom: none; }

        .feature-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .feature-info { flex: 1; min-width: 0; }
        .feature-name { font-weight: 500; margin-bottom: 4px; }

        .feature-bar-container {
            height: 6px;
            background: var(--bg-surface);
            border-radius: 3px;
            overflow: hidden;
        }

        .feature-bar {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .feature-stats { text-align: right; min-width: 80px; }
        .feature-count { font-size: 18px; font-weight: 600; }
        .feature-percent { font-size: 12px; color: var(--text-muted); }

        /* ========================================
           Event Log
           ======================================== */
        .event-log-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            margin-bottom: 28px;
        }

        .event-log-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .event-filter { display: flex; gap: 8px; flex-wrap: wrap; }

        .event-filter-btn {
            padding: 6px 12px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-muted);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .event-filter-btn:hover,
        .event-filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .event-log-content { max-height: 400px; overflow-y: auto; }

        .event-item {
            display: flex;
            align-items: flex-start;
            gap: 14px;
            padding: 14px 24px;
            border-bottom: 1px solid var(--border);
            transition: background 0.2s ease;
        }

        .event-item:hover { background: var(--bg-card-hover); }
        .event-item:last-child { border-bottom: none; }

        .event-type-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-top: 5px;
            flex-shrink: 0;
        }

        .event-type-indicator.pageview { background: var(--chart-1); }
        .event-type-indicator.midi { background: var(--chart-3); }
        .event-type-indicator.instrument { background: var(--chart-4); }
        .event-type-indicator.theme { background: var(--chart-5); }
        .event-type-indicator.chord { background: var(--chart-7); }
        .event-type-indicator.session { background: var(--chart-2); }

        .event-details { flex: 1; min-width: 0; }
        .event-message { font-size: 13px; margin-bottom: 4px; }

        .event-meta {
            display: flex;
            gap: 16px;
            font-size: 11px;
            color: var(--text-dim);
            flex-wrap: wrap;
        }

        .event-time {
            text-align: right;
            font-size: 12px;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .session-duration { font-family: 'Monaco', 'Consolas', monospace; font-size: 12px; }

        .page-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 28px;
            height: 24px;
            background: rgba(99, 102, 241, 0.15);
            color: var(--primary);
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }

        /* ========================================
           Loading & Empty States
           ======================================== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 15, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.active { opacity: 1; visibility: visible; }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .empty-state {
            padding: 60px 24px;
            text-align: center;
            color: var(--text-muted);
        }

        /* ========================================
           Toast Notifications
           ======================================== */
        .toast-container {
            position: fixed;
            top: 24px;
            right: 24px;
            z-index: 1100;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            padding: 14px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 13px;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.success { border-left: 3px solid var(--success); }
        .toast.error { border-left: 3px solid var(--danger); }
        .toast.info { border-left: 3px solid var(--info); }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ========================================
           Modal
           ======================================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(10, 10, 15, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active { opacity: 1; visibility: visible; }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal { transform: scale(1); }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title { font-size: 18px; font-weight: 600; }

        .modal-close {
            width: 32px;
            height: 32px;
            border: none;
            background: var(--bg-surface);
            border-radius: 8px;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .modal-close:hover { background: var(--bg-card-hover); color: var(--text); }

        .modal-body {
            padding: 24px;
            max-height: calc(80vh - 80px);
            overflow-y: auto;
        }

        .user-detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .user-detail-item {
            background: var(--bg-surface);
            padding: 16px;
            border-radius: 10px;
        }

        .user-detail-label { font-size: 12px; color: var(--text-muted); margin-bottom: 4px; }
        .user-detail-value { font-size: 18px; font-weight: 600; }

        /* ========================================
           Real-time Indicator
           ======================================== */
        .realtime-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 8px;
            font-size: 12px;
            color: var(--success);
        }

        .realtime-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .section-badge {
            background: var(--bg-surface);
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 12px;
            color: var(--text-muted);
        }

        /* ========================================
           Responsive
           ======================================== */
        @media (max-width: 768px) {
            .dashboard { padding: 16px; }
            .header { flex-direction: column; align-items: flex-start; }
            .header-actions { width: 100%; }
            .date-range-selector { flex-wrap: wrap; }
            .stat-card-value { font-size: 28px; }
            .user-detail-grid { grid-template-columns: 1fr; }
            .event-log-header { flex-direction: column; gap: 12px; align-items: flex-start; }
        }
    </style>
</head>
<body>
    <!-- Login Overlay -->
    <div id="login-overlay">
        <div class="login-box">
            <h1>Chord-ID Analytics</h1>
            <p>Enter the admin password to view statistics</p>
            <input type="password" id="password-input" placeholder="Password" autofocus>
            <p class="login-error" id="login-error">Incorrect password. Please try again.</p>
            <button class="btn btn-primary" style="width: 100%;" onclick="checkPassword()">Login</button>
        </div>
    </div>

    <div class="dashboard" id="dashboard">
        <!-- Header Section -->
        <header class="header">
            <div class="header-title">
                <div>
                    <h1>Chord-ID Analytics</h1>
                    <p class="header-subtitle">Real-time usage insights and statistics</p>
                </div>
            </div>
            <div class="header-actions">
                <div class="realtime-indicator">
                    <span class="realtime-dot"></span>
                    <span>Live</span>
                </div>
                <div class="date-range-selector">
                    <button class="date-range-btn" data-range="today">Today</button>
                    <button class="date-range-btn active" data-range="7d">7 Days</button>
                    <button class="date-range-btn" data-range="30d">30 Days</button>
                    <button class="date-range-btn" data-range="90d">90 Days</button>
                    <button class="date-range-btn" data-range="all">All Time</button>
                </div>
                <button class="btn btn-secondary btn-icon" id="refresh-btn" title="Refresh Data">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                </button>
                <button class="btn btn-success" id="export-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                    </svg>
                    Export CSV
                </button>
            </div>
        </header>

        <!-- Overview Cards -->
        <section class="overview-grid">
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon users">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                        </svg>
                    </div>
                    <div class="stat-card-trend up" id="users-trend-badge">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                        </svg>
                        <span id="users-trend">--</span>
                    </div>
                </div>
                <div class="stat-card-value" id="total-users">--</div>
                <div class="stat-card-label">Total Users</div>
                <div class="stat-card-spark"><canvas id="spark-users"></canvas></div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon sessions">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                    </div>
                    <div class="stat-card-trend up" id="sessions-trend-badge">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                        </svg>
                        <span id="sessions-trend">--</span>
                    </div>
                </div>
                <div class="stat-card-value" id="active-sessions">--</div>
                <div class="stat-card-label">Sessions Today</div>
                <div class="stat-card-spark"><canvas id="spark-sessions"></canvas></div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon duration">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div class="stat-card-trend neutral" id="duration-trend-badge">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                        </svg>
                        <span id="duration-trend">--</span>
                    </div>
                </div>
                <div class="stat-card-value" id="avg-duration">--</div>
                <div class="stat-card-label">Avg Session Duration</div>
                <div class="stat-card-spark"><canvas id="spark-duration"></canvas></div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon events">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                    </div>
                    <div class="stat-card-trend up" id="events-trend-badge">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 10l7-7m0 0l7 7m-7-7v18" />
                        </svg>
                        <span id="events-trend">--</span>
                    </div>
                </div>
                <div class="stat-card-value" id="total-events">--</div>
                <div class="stat-card-label">Total Events</div>
                <div class="stat-card-spark"><canvas id="spark-events"></canvas></div>
            </div>
        </section>

        <!-- Charts Row 1 -->
        <section class="charts-grid">
            <div class="chart-card">
                <div class="chart-card-header">
                    <div class="chart-card-title">
                        <div class="chart-card-title-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="white">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
                            </svg>
                        </div>
                        Users Over Time
                    </div>
                </div>
                <div class="chart-container"><canvas id="chart-users-time"></canvas></div>
            </div>

            <div class="chart-card">
                <div class="chart-card-header">
                    <div class="chart-card-title">
                        <div class="chart-card-title-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="white">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                            </svg>
                        </div>
                        Sessions by Hour
                    </div>
                </div>
                <div class="chart-container"><canvas id="chart-sessions-hour"></canvas></div>
            </div>
        </section>

        <!-- Charts Row 2 -->
        <section class="charts-grid">
            <div class="chart-card">
                <div class="chart-card-header">
                    <div class="chart-card-title">
                        <div class="chart-card-title-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="white">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                        </div>
                        Users by Platform
                    </div>
                </div>
                <div class="chart-container pie"><canvas id="chart-platforms"></canvas></div>
            </div>

            <div class="chart-card">
                <div class="chart-card-header">
                    <div class="chart-card-title">
                        <div class="chart-card-title-icon">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="white">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                            </svg>
                        </div>
                        Most Used Instruments
                    </div>
                </div>
                <div class="chart-container pie"><canvas id="chart-instruments"></canvas></div>
            </div>
        </section>

        <!-- Engagement Section -->
        <section class="engagement-grid">
            <div class="table-card">
                <div class="table-card-header">
                    <div class="table-card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="var(--primary)">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
                        </svg>
                        Feature Usage
                    </div>
                </div>
                <div id="feature-usage-list">
                    <div class="empty-state"><p>Loading feature data...</p></div>
                </div>
            </div>

            <div class="table-card">
                <div class="table-card-header">
                    <div class="table-card-title">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="var(--secondary)">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
                        </svg>
                        Chord Detection Stats
                    </div>
                </div>
                <div class="table-wrapper">
                    <table class="data-table" id="chord-stats-table">
                        <thead>
                            <tr><th>Chord Type</th><th>Detections</th><th>% of Total</th></tr>
                        </thead>
                        <tbody id="chord-stats-body">
                            <tr><td colspan="3" class="empty-state">Loading chord data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- User Table -->
        <section class="table-card" style="margin-bottom: 28px;">
            <div class="table-card-header">
                <div class="table-card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="var(--accent)">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                    Users
                </div>
                <span class="section-badge" id="users-range-badge">All Time</span>
            </div>
            <div class="table-wrapper">
                <table class="data-table" id="users-table">
                    <thead>
                        <tr>
                            <th>Visitor ID</th><th>First Seen</th><th>Last Seen</th>
                            <th>Total Visits</th><th>Total Time</th><th>Platform</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <tr><td colspan="6" class="empty-state">Loading users...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="table-footer">
                <div class="table-info" id="users-table-info">Showing 0 users</div>
                <div class="pagination" id="users-pagination"></div>
            </div>
        </section>

        <!-- Session Table -->
        <section class="table-card" style="margin-bottom: 28px;">
            <div class="table-card-header">
                <div class="table-card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="var(--success)">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Recent Sessions
                </div>
                <span class="section-badge" id="sessions-range-badge">Today</span>
            </div>
            <div class="table-wrapper">
                <table class="data-table" id="sessions-table">
                    <thead>
                        <tr>
                            <th>Session ID</th><th>User</th><th>Started</th>
                            <th>Duration</th><th>Pages</th><th>Entry</th><th>Exit</th>
                        </tr>
                    </thead>
                    <tbody id="sessions-table-body">
                        <tr><td colspan="7" class="empty-state">Loading sessions...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="table-footer">
                <div class="table-info" id="sessions-table-info">Showing 0 sessions</div>
                <div class="pagination" id="sessions-pagination"></div>
            </div>
        </section>

        <!-- Event Log -->
        <section class="event-log-card">
            <div class="event-log-header">
                <div class="table-card-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="var(--warning)">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    Event Log
                </div>
                <div class="event-filter" id="event-filter">
                    <button class="event-filter-btn active" data-filter="all">All</button>
                </div>
            </div>
            <div class="event-log-content" id="event-log-content">
                <div class="empty-state"><p>Loading events...</p></div>
            </div>
        </section>
    </div>

    <!-- User Detail Modal -->
    <div class="modal-overlay" id="user-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">User Details</h3>
                <button class="modal-close" onclick="closeUserModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="user-detail-grid">
                    <div class="user-detail-item">
                        <div class="user-detail-label">Visitor ID</div>
                        <div class="user-detail-value" id="modal-visitor-id">--</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">Platform</div>
                        <div class="user-detail-value" id="modal-platform">--</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">First Seen</div>
                        <div class="user-detail-value" id="modal-first-seen">--</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">Last Seen</div>
                        <div class="user-detail-value" id="modal-last-seen">--</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">Total Visits</div>
                        <div class="user-detail-value" id="modal-visits">--</div>
                    </div>
                    <div class="user-detail-item">
                        <div class="user-detail-label">Total Time</div>
                        <div class="user-detail-value" id="modal-time">--</div>
                    </div>
                </div>
                <h4 style="margin-bottom: 12px; font-size: 14px; color: var(--text-muted);">Recent Activity</h4>
                <div class="event-log-content" style="max-height: 200px;" id="modal-activity">
                    <div class="empty-state"><p>No recent activity</p></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay"><div class="loading-spinner"></div></div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <script>
        const ADMIN_PASSWORD = '32156';
        const state = { dateRange: '7d', currentPage: { users: 1, sessions: 1, events: 1 }, eventFilter: 'all', refreshInterval: null, charts: {}, data: null };

        // Authentication
        function checkSession() { if (sessionStorage.getItem('chord-id-admin-auth') === 'true') showDashboard(); }
        function checkPassword() {
            const input = document.getElementById('password-input');
            const error = document.getElementById('login-error');
            if (input.value === ADMIN_PASSWORD) { sessionStorage.setItem('chord-id-admin-auth', 'true'); showDashboard(); }
            else { error.style.display = 'block'; input.value = ''; input.focus(); }
        }
        function showDashboard() { document.getElementById('login-overlay').style.display = 'none'; document.getElementById('dashboard').style.display = 'block'; initDashboard(); }
        document.getElementById('password-input').addEventListener('keypress', function(e) { if (e.key === 'Enter') checkPassword(); });

        // Utilities
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">${type === 'success' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />' : type === 'error' ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />' : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />'}</svg><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; toast.style.transform = 'translateX(100%)'; setTimeout(() => toast.remove(), 300); }, 3000);
        }
        function formatNumber(num) { return new Intl.NumberFormat().format(num); }
        function formatDate(dateStr) { if (!dateStr) return '--'; return new Date(dateStr).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); }
        function formatTime(dateStr) { if (!dateStr) return '--'; return new Date(dateStr).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }); }
        function formatDuration(seconds) { if (!seconds || seconds < 0) return '0s'; if (seconds < 60) return Math.round(seconds) + 's'; if (seconds < 3600) return `${Math.floor(seconds / 60)}m ${Math.round(seconds % 60)}s`; return `${Math.floor(seconds / 3600)}h ${Math.floor((seconds % 3600) / 60)}m`; }
        function timeAgo(dateStr) { if (!dateStr) return '--'; const seconds = Math.floor((new Date() - new Date(dateStr)) / 1000); if (seconds < 60) return 'Just now'; if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago'; if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago'; if (seconds < 604800) return Math.floor(seconds / 86400) + 'd ago'; return formatDate(dateStr); }
        function getPlatformClass(platform) { if (!platform) return 'unknown'; const p = platform.toLowerCase(); if (p.includes('windows')) return 'windows'; if (p.includes('mac')) return 'macos'; if (p.includes('linux')) return 'linux'; if (p.includes('android')) return 'android'; if (p.includes('ios') || p.includes('iphone') || p.includes('ipad')) return 'ios'; return 'unknown'; }

        // Chart config
        const chartColors = { primary: '#6366f1', secondary: '#8b5cf6', accent: '#22d3ee', success: '#22c55e', warning: '#f59e0b', danger: '#ef4444', pink: '#ec4899', teal: '#14b8a6' };

        // Data fetching
        async function fetchData(action, params = {}) {
            const url = new URL(window.location.href);
            url.searchParams.set('action', action);
            url.searchParams.set('range', state.dateRange);
            Object.entries(params).forEach(([key, value]) => url.searchParams.set(key, value));
            try { const response = await fetch(url.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' } }); return await response.json(); }
            catch (error) { console.error('Fetch error:', error); return { success: false, error: error.message }; }
        }

        async function refreshDashboard() {
            const refreshBtn = document.getElementById('refresh-btn');
            refreshBtn.classList.add('loading');
            try {
                const overviewData = await fetchData('get_overview');
                if (overviewData.success) { state.data = overviewData.data; updateOverviewCards(overviewData.data); updateCharts(overviewData.data); updateFeatureUsage(overviewData.data); }
                const usersData = await fetchData('get_users', { page: state.currentPage.users, limit: 10 });
                if (usersData.success) updateUsersTable(usersData.data);
                const sessionsData = await fetchData('get_sessions', { page: state.currentPage.sessions, limit: 10 });
                if (sessionsData.success) updateSessionsTable(sessionsData.data);
                const eventsData = await fetchData('get_events', { page: state.currentPage.events, limit: 20, event_type: state.eventFilter === 'all' ? '' : state.eventFilter });
                if (eventsData.success) updateEventLog(eventsData.data);
                const trendsData = await fetchData('get_trends');
                if (trendsData.success) updateTrendCharts(trendsData.data);
                showToast('Data refreshed', 'success');
            } catch (error) { console.error('Error refreshing dashboard:', error); showToast('Failed to refresh data', 'error'); }
            finally { refreshBtn.classList.remove('loading'); }
        }

        // Update functions
        function updateOverviewCards(data) {
            const users = data.users || {}; const sessions = data.sessions || {}; const engagement = data.engagement || {};
            document.getElementById('total-users').textContent = formatNumber(users.total || 0);
            document.getElementById('active-sessions').textContent = formatNumber(sessions.today || 0);
            document.getElementById('avg-duration').textContent = sessions.avg_duration_formatted || '0s';
            document.getElementById('total-events').textContent = formatNumber(engagement.total_events || 0);
            document.getElementById('users-trend').textContent = users.new_this_week > 0 ? '+' + users.new_this_week : '0';
            document.getElementById('sessions-trend').textContent = sessions.this_week > 0 ? '+' + sessions.this_week : '0';
        }

        function updateCharts(data) {
            const platformsCtx = document.getElementById('chart-platforms');
            if (platformsCtx && data.users && data.users.by_platform) {
                if (state.charts.platforms) state.charts.platforms.destroy();
                const platformData = data.users.by_platform.slice(0, 6);
                state.charts.platforms = new Chart(platformsCtx, { type: 'doughnut', data: { labels: platformData.map(p => p.platform || 'Unknown'), datasets: [{ data: platformData.map(p => p.count), backgroundColor: [chartColors.primary, chartColors.secondary, chartColors.success, chartColors.accent, chartColors.warning, chartColors.danger], borderWidth: 0, spacing: 2 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'right', labels: { color: '#94a3b8', font: { family: 'Inter', size: 12 }, padding: 12, usePointStyle: true, pointStyle: 'circle' } } } } });
            }
            const instrumentsCtx = document.getElementById('chart-instruments');
            if (instrumentsCtx && data.engagement && data.engagement.most_used_instruments && data.engagement.most_used_instruments.length > 0) {
                if (state.charts.instruments) state.charts.instruments.destroy();
                const instrumentData = data.engagement.most_used_instruments.slice(0, 6);
                state.charts.instruments = new Chart(instrumentsCtx, { type: 'doughnut', data: { labels: instrumentData.map(i => i.instrument || 'Unknown'), datasets: [{ data: instrumentData.map(i => i.count), backgroundColor: [chartColors.accent, chartColors.pink, chartColors.teal, chartColors.warning, chartColors.secondary, chartColors.danger], borderWidth: 0, spacing: 2 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '65%', plugins: { legend: { position: 'right', labels: { color: '#94a3b8', font: { family: 'Inter', size: 12 }, padding: 12, usePointStyle: true, pointStyle: 'circle' } } } } });
            }
            const sessionsHourCtx = document.getElementById('chart-sessions-hour');
            if (sessionsHourCtx && data.sessions && data.sessions.by_hour) {
                if (state.charts.sessionsHour) state.charts.sessionsHour.destroy();
                const hourLabels = Array.from({length: 24}, (_, i) => `${i.toString().padStart(2, '0')}:00`);
                const hourData = new Array(24).fill(0);
                data.sessions.by_hour.forEach(h => { hourData[h.hour] = h.count; });
                const maxVal = Math.max(...hourData, 1);
                state.charts.sessionsHour = new Chart(sessionsHourCtx, { type: 'bar', data: { labels: hourLabels, datasets: [{ label: 'Sessions', data: hourData, backgroundColor: hourData.map(val => `rgba(99, 102, 241, ${0.3 + (val / maxVal) * 0.7})`), borderRadius: 4, borderSkipped: false }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#64748b', font: { family: 'Inter', size: 11 } } }, y: { grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#64748b', font: { family: 'Inter', size: 11 } } } } } });
            }
        }

        function updateTrendCharts(data) {
            const usersTimeCtx = document.getElementById('chart-users-time');
            if (usersTimeCtx && data.sessions_over_time) {
                if (state.charts.usersTime) state.charts.usersTime.destroy();
                const sessions = data.sessions_over_time;
                state.charts.usersTime = new Chart(usersTimeCtx, { type: 'line', data: { labels: sessions.map(s => s.label), datasets: [{ label: 'Sessions', data: sessions.map(s => s.sessions), borderColor: chartColors.primary, backgroundColor: 'rgba(99, 102, 241, 0.1)', borderWidth: 2, fill: true, tension: 0.4 }, { label: 'Unique Users', data: sessions.map(s => s.unique_users), borderColor: chartColors.secondary, backgroundColor: 'rgba(139, 92, 246, 0.1)', borderWidth: 2, fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false, interaction: { intersect: false, mode: 'index' }, plugins: { legend: { labels: { color: '#94a3b8', font: { family: 'Inter', size: 12 }, padding: 16 } } }, scales: { x: { grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#64748b', font: { family: 'Inter', size: 11 } } }, y: { grid: { color: 'rgba(255, 255, 255, 0.05)' }, ticks: { color: '#64748b', font: { family: 'Inter', size: 11 } } } } } });
            }
        }

        function updateFeatureUsage(data) {
            const container = document.getElementById('feature-usage-list');
            if (!container || !data.engagement || !data.engagement.by_type) { container.innerHTML = '<div class="empty-state"><p>No feature data available</p></div>'; return; }
            const features = data.engagement.by_type;
            const total = features.reduce((sum, f) => sum + f.count, 0);
            const icons = { 'instrument_switch': ['M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3', ['var(--chart-1)', 'var(--chart-2)']], 'theme_change': ['M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01', ['var(--chart-3)', 'var(--chart-4)']], 'midi_connect': ['M13 10V3L4 14h7v7l9-11h-7z', ['var(--chart-5)', 'var(--chart-6)']], 'chord_detected': ['M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3', ['var(--chart-7)', 'var(--chart-8)']] };
            container.innerHTML = features.slice(0, 5).map(f => {
                const percent = total > 0 ? Math.round((f.count / total) * 100) : 0;
                const iconData = icons[f.event_type] || ['M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z', ['var(--chart-1)', 'var(--chart-2)']];
                const name = f.event_type.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                return `<div class="feature-row"><div class="feature-icon" style="background: linear-gradient(135deg, ${iconData[1][0]}, ${iconData[1][1]});"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="white"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${iconData[0]}" /></svg></div><div class="feature-info"><div class="feature-name">${name}</div><div class="feature-bar-container"><div class="feature-bar" style="width: ${percent}%; background: linear-gradient(90deg, ${iconData[1][0]}, ${iconData[1][1]});"></div></div></div><div class="feature-stats"><div class="feature-count">${formatNumber(f.count)}</div><div class="feature-percent">${percent}%</div></div></div>`;
            }).join('');
        }

        function updateUsersTable(data) {
            const tbody = document.getElementById('users-table-body');
            const info = document.getElementById('users-table-info');
            const pagination = document.getElementById('users-pagination');
            if (!data.users || data.users.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No users found</td></tr>'; info.textContent = 'No users'; pagination.innerHTML = ''; return; }
            tbody.innerHTML = data.users.map(user => `<tr><td><span class="visitor-id" onclick="showUserDetail('${user.visitor_id}')">${user.visitor_id.substring(0, 8)}</span></td><td>${formatDate(user.first_seen)}</td><td>${timeAgo(user.last_seen)}</td><td>${user.total_visits || 0}</td><td>${formatDuration(user.total_time_seconds)}</td><td><span class="platform-badge ${getPlatformClass(user.platform)}">${user.platform || 'Unknown'}</span></td></tr>`).join('');
            const p = data.pagination;
            info.textContent = `Showing ${(p.page - 1) * p.limit + 1}-${Math.min(p.page * p.limit, p.total)} of ${formatNumber(p.total)} users`;
            let html = `<button class="pagination-btn" onclick="changePage('users', ${p.page - 1})" ${p.page <= 1 ? 'disabled' : ''}>&laquo;</button>`;
            for (let i = 1; i <= Math.min(p.total_pages, 5); i++) html += `<button class="pagination-btn ${i === p.page ? 'active' : ''}" onclick="changePage('users', ${i})">${i}</button>`;
            if (p.total_pages > 5) html += `<button class="pagination-btn" disabled>...</button><button class="pagination-btn" onclick="changePage('users', ${p.total_pages})">${p.total_pages}</button>`;
            html += `<button class="pagination-btn" onclick="changePage('users', ${p.page + 1})" ${p.page >= p.total_pages ? 'disabled' : ''}>&raquo;</button>`;
            pagination.innerHTML = html;
        }

        function updateSessionsTable(data) {
            const tbody = document.getElementById('sessions-table-body');
            const info = document.getElementById('sessions-table-info');
            if (!data.sessions || data.sessions.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No sessions found</td></tr>'; info.textContent = 'No sessions'; return; }
            tbody.innerHTML = data.sessions.map(s => `<tr><td><span class="visitor-id">${s.session_id.substring(0, 10)}</span></td><td><span class="visitor-id" onclick="showUserDetail('${s.visitor_id}')">${s.visitor_id.substring(0, 8)}</span></td><td>${formatTime(s.started_at)}</td><td class="session-duration">${formatDuration(s.duration_seconds)}</td><td><span class="page-count">${s.page_views || 0}</span></td><td>${s.entry_page || '--'}</td><td>${s.exit_page || '--'}</td></tr>`).join('');
            const p = data.pagination;
            info.textContent = `Showing ${(p.page - 1) * p.limit + 1}-${Math.min(p.page * p.limit, p.total)} of ${formatNumber(p.total)} sessions`;
        }

        function updateEventLog(data) {
            const content = document.getElementById('event-log-content');
            const filter = document.getElementById('event-filter');
            if (data.event_types && data.event_types.length > 0) {
                let filterHtml = '<button class="event-filter-btn active" data-filter="all">All</button>';
                data.event_types.slice(0, 6).forEach(type => { filterHtml += `<button class="event-filter-btn" data-filter="${type.event_type}">${type.event_type.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase())}</button>`; });
                filter.innerHTML = filterHtml;
                filter.querySelectorAll('.event-filter-btn').forEach(btn => { btn.addEventListener('click', () => { filter.querySelector('.event-filter-btn.active')?.classList.remove('active'); btn.classList.add('active'); state.eventFilter = btn.dataset.filter; state.currentPage.events = 1; refreshDashboard(); }); });
            }
            if (!data.events || data.events.length === 0) { content.innerHTML = '<div class="empty-state"><p>No events found</p></div>'; return; }
            content.innerHTML = data.events.map(event => {
                const eventClass = event.event_type.split('_')[0];
                const eventData = typeof event.event_data === 'string' ? JSON.parse(event.event_data || '{}') : (event.event_data || {});
                const name = event.event_type.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                let details = '';
                if (eventData.instrument) details += `<span>Instrument: ${eventData.instrument}</span>`;
                if (eventData.theme) details += `<span>Theme: ${eventData.theme}</span>`;
                if (eventData.chord) details += `<span>Chord: ${eventData.chord}</span>`;
                return `<div class="event-item" data-type="${eventClass}"><span class="event-type-indicator ${eventClass}"></span><div class="event-details"><div class="event-message">${name}</div><div class="event-meta"><span>User: ${event.visitor_id.substring(0, 8)}</span>${details}</div></div><div class="event-time">${timeAgo(event.timestamp)}</div></div>`;
            }).join('');
        }

        async function changePage(type, page) { if (page < 1) return; state.currentPage[type] = page; if (type === 'users') { const data = await fetchData('get_users', { page, limit: 10 }); if (data.success) updateUsersTable(data.data); } else if (type === 'sessions') { const data = await fetchData('get_sessions', { page, limit: 10 }); if (data.success) updateSessionsTable(data.data); } }

        async function showUserDetail(visitorId) {
            const modal = document.getElementById('user-modal');
            const usersData = await fetchData('get_users', { limit: 1000 });
            if (usersData.success) {
                const user = usersData.data.users.find(u => u.visitor_id === visitorId || u.visitor_id.startsWith(visitorId));
                if (user) { document.getElementById('modal-visitor-id').textContent = user.visitor_id; document.getElementById('modal-platform').textContent = user.platform || 'Unknown'; document.getElementById('modal-first-seen').textContent = formatDate(user.first_seen); document.getElementById('modal-last-seen').textContent = timeAgo(user.last_seen); document.getElementById('modal-visits').textContent = user.total_visits || 0; document.getElementById('modal-time').textContent = formatDuration(user.total_time_seconds); }
            }
            modal.classList.add('active');
        }
        function closeUserModal() { document.getElementById('user-modal').classList.remove('active'); }

        function exportCSV() { window.location.href = `?action=export_csv&type=users&range=${state.dateRange}`; showToast('CSV export started', 'info'); }

        function initEventHandlers() {
            document.querySelectorAll('.date-range-btn').forEach(btn => { btn.addEventListener('click', () => { document.querySelector('.date-range-btn.active')?.classList.remove('active'); btn.classList.add('active'); state.dateRange = btn.dataset.range; state.currentPage = { users: 1, sessions: 1, events: 1 }; refreshDashboard(); }); });
            document.getElementById('refresh-btn').addEventListener('click', refreshDashboard);
            document.getElementById('export-btn').addEventListener('click', exportCSV);
            document.getElementById('user-modal').addEventListener('click', (e) => { if (e.target.classList.contains('modal-overlay')) closeUserModal(); });
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeUserModal(); if (e.key === 'r' && (e.ctrlKey || e.metaKey)) { e.preventDefault(); refreshDashboard(); } });
        }

        function startAutoRefresh() { state.refreshInterval = setInterval(refreshDashboard, 30000); }
        function stopAutoRefresh() { if (state.refreshInterval) { clearInterval(state.refreshInterval); state.refreshInterval = null; } }
        document.addEventListener('visibilitychange', () => { if (document.hidden) stopAutoRefresh(); else startAutoRefresh(); });

        function initDashboard() { initEventHandlers(); refreshDashboard(); startAutoRefresh(); }

        checkSession();
    </script>
</body>
</html>
